<section class="card">
  <div class="client-header-row">
    <div>
      <h1 class="card-title">Klantfiche</h1>
      <p class="card-text">
        Dit is de officiële klantfiche van je bedrijf in <strong>MyPunctoo</strong>.
        Deze gegevens worden gebruikt voor <strong>abonnement</strong> en <strong>facturen</strong> en zijn niet rechtstreeks aanpasbaar in het portaal.
      </p>
    </div>

    <div class="client-status">
      <span class="client-status-label">Status</span>
      <span class="client-status-badge client-status-badge--active" id="client-status-badge">Actief</span>

      <!-- ✅ alleen nog de 2 “source of truth” velden -->
      <div class="client-status-meta" id="client-status-meta">
        Account aangemaakt: <strong>–</strong><br>
        Klantnummer: <strong>–</strong>
      </div>
    </div>
  </div>

  <div class="client-grid">
    <!-- Basisgegevens -->
    <div class="client-block">
      <h2 class="client-block-title">Basisgegevens</h2>

      <div class="client-row">
        <div class="client-label">Bedrijfsnaam</div>
        <div class="client-value" id="cr-company-name">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Ondernemingsnummer</div>
        <div class="client-value" id="cr-enterprise-number">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Klantnummer</div>
        <div class="client-value" id="cr-customer-number">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Website</div>
        <div class="client-value" id="cr-website">–</div>
      </div>
    </div>

    <!-- Contact & facturatie -->
    <div class="client-block">
      <h2 class="client-block-title">Contact & facturatie</h2>

      <div class="client-row">
        <div class="client-label">Contactpersoon (zetel)</div>
        <div class="client-value" id="cr-registered-contact">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Facturatie e-mail</div>
        <div class="client-value" id="cr-billing-email">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Referentie / PO</div>
        <div class="client-value" id="cr-billing-ref">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Leveringscontact</div>
        <div class="client-value" id="cr-delivery-contact">–</div>
      </div>
    </div>
  </div>

  <!-- Adressen -->
  <div class="client-grid" style="margin-top: 18px;">
    <div class="client-block">
      <h2 class="client-block-title">Maatschappelijke zetel</h2>

      <div class="client-row">
        <div class="client-label">Straat + nummer</div>
        <div class="client-value" id="cr-registered-street">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Bus</div>
        <div class="client-value" id="cr-registered-box">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Postcode</div>
        <div class="client-value" id="cr-registered-postal">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Gemeente</div>
        <div class="client-value" id="cr-registered-city">–</div>
      </div>
    </div>

    <div class="client-block">
      <h2 class="client-block-title">Leveringsadres</h2>

      <div class="client-row">
        <div class="client-label">Straat + nummer</div>
        <div class="client-value" id="cr-delivery-street">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Bus</div>
        <div class="client-value" id="cr-delivery-box">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Postcode</div>
        <div class="client-value" id="cr-delivery-postal">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Gemeente</div>
        <div class="client-value" id="cr-delivery-city">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Opmerking</div>
        <div class="client-value" id="cr-delivery-note">–</div>
      </div>
    </div>
  </div>

  <div class="client-contact">
    <p class="client-contact-text">
      Wijziging nodig? Neem contact op met support.
    </p>
    <a class="client-contact-btn" href="mailto:support@mypunctoo.com">
      Wijziging aanvragen
    </a>
  </div>
</section>

<script>
(function () {
  const AUTH_TOKEN_KEY = "mypunctoo_auth_token";

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function norm(v) {
    if (v === null || v === undefined) return "";
    const s = String(v).trim();
    return s;
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    const v = norm(value);
    el.textContent = v ? v : "–";
  }

  function formatDateTimeISO(v) {
    if (!v) return "–";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return String(v);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  async function apiFetch(url, opts = {}) {
    const token = window.localStorage.getItem(AUTH_TOKEN_KEY) || "";
    const headers = Object.assign({}, opts.headers || {});
    if (token) headers["Authorization"] = `Bearer ${token}`;
    return fetch(url, Object.assign({}, opts, { headers }));
  }

  function isTruthy(v) {
    return v === true || v === "true" || v === 1 || v === "1";
  }

  async function hydrate() {
    try {
      const res = await apiFetch("/api/company", { cache: "no-cache" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) throw new Error(data.error || "Kon bedrijf niet laden.");

      const c = data.company || {};

      // Basis
      setText("cr-company-name", c.name || c.company_name);
      setText("cr-enterprise-number", c.vat_number); // inhoud = ondernemingsnummer
      setText("cr-customer-number", c.customer_number);
      setText("cr-website", c.website);

      // Contact & facturatie (gebruik echte kolommen)
      setText("cr-registered-contact", c.registered_contact_person);
      setText("cr-billing-email", c.billing_email);
      setText("cr-billing-ref", c.billing_reference);
      setText("cr-delivery-contact", c.delivery_contact_person);

      // Zetel adres
      setText("cr-registered-street", c.registered_street);
      setText("cr-registered-box", c.registered_box);
      setText("cr-registered-postal", c.registered_postal_code);
      setText("cr-registered-city", c.registered_city);

      // Levering: als niets ingevuld is, toon zetel (want delivery_is_different = false)
      const deliveryIsDifferent = isTruthy(c.delivery_is_different);
      const dStreet = deliveryIsDifferent ? c.delivery_street : (c.delivery_street || c.registered_street);
      const dBox    = deliveryIsDifferent ? c.delivery_box : (c.delivery_box || c.registered_box);
      const dPostal = deliveryIsDifferent ? c.delivery_postal_code : (c.delivery_postal_code || c.registered_postal_code);
      const dCity   = deliveryIsDifferent ? c.delivery_city : (c.delivery_city || c.registered_city);

      setText("cr-delivery-street", dStreet);
      setText("cr-delivery-box", dBox);
      setText("cr-delivery-postal", dPostal);
      setText("cr-delivery-city", dCity);
      setText("cr-delivery-note", deliveryIsDifferent ? "Afwijkend leveringsadres" : "Gelijk aan maatschappelijke zetel");

      // Meta: alleen source-of-truth
      const metaEl = document.getElementById("client-status-meta");
      if (metaEl) {
        const created = formatDateTimeISO(c.created_at);
        const custNo = c.customer_number ?? "–";
        metaEl.innerHTML =
          `Account aangemaakt: <strong>${escapeHtml(created)}</strong><br>` +
          `Klantnummer: <strong>${escapeHtml(custNo)}</strong>`;
      }
    } catch (e) {
      console.warn(e);
    }
  }

  hydrate();
})();
</script>
