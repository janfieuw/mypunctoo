<section class="card">
  <style>
    /* Panels zoals screenshot */
    .cr-wrap { display: grid; gap: 18px; }

    .cr-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 980px) { .cr-grid-2 { grid-template-columns: 1fr; } }

    .cr-panel {
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff 0%, #f2f3f5 100%);
      padding: 16px 18px;
    }

    .cr-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 13px;
      margin: 0 0 10px 0;
    }

    .cr-kv {
      display: grid;
      grid-template-columns: 210px 1fr;
      row-gap: 8px;
      column-gap: 18px;
      align-items: start;
      font-size: 13px;
    }
    @media (max-width: 520px) { .cr-kv { grid-template-columns: 1fr; } }

    .cr-k { opacity: 0.85; white-space: nowrap; }
    .cr-v { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>

  <div class="cr-wrap">
    <!-- Rij 1: klantnummer/created + emails -->
    <div class="cr-grid-2">
      <div class="cr-panel">
        <div class="cr-kv">
          <div class="cr-k">Klantnummer</div>
          <div class="cr-v" id="cr-customer-number">–</div>

          <div class="cr-k">Account aangemaakt</div>
          <div class="cr-v" id="cr-created-at">–</div>
        </div>
      </div>

      <div class="cr-panel">
        <div class="cr-kv">
          <div class="cr-k">Contact e-mail</div>
          <div class="cr-v" id="cr-contact-email">–</div>

          <div class="cr-k">Facturatie e-mail</div>
          <div class="cr-v" id="cr-billing-email">–</div>
        </div>
      </div>
    </div>

    <!-- Rij 2: Facturatie + Levering -->
    <div class="cr-grid-2">
      <div class="cr-panel">
        <h3 class="cr-title">Facturatie</h3>
        <div class="cr-kv">
          <div class="cr-k">Bedrijfsnaam</div>
          <div class="cr-v" id="cr-name">–</div>

          <div class="cr-k">Ondernemingsnummer</div>
          <div class="cr-v" id="cr-vat-number">–</div>

          <div class="cr-k">Straat + nummer</div>
          <div class="cr-v" id="cr-registered-street">–</div>

          <div class="cr-k">PC + gemeente</div>
          <div class="cr-v" id="cr-registered-postal">–</div>

          <div class="cr-k">Contactpersoon (zetel)</div>
          <div class="cr-v" id="cr-registered-contact">–</div>
        </div>
      </div>

      <div class="cr-panel">
        <h3 class="cr-title">Levering</h3>
        <div class="cr-kv">
          <div class="cr-k">Bedrijfsnaam</div>
          <div class="cr-v" id="cr-delivery-name">–</div>

          <div class="cr-k">Contactpersoon (levering)</div>
          <div class="cr-v" id="cr-delivery-contact">–</div>

          <div class="cr-k">Straat + nummer</div>
          <div class="cr-v" id="cr-delivery-street">–</div>

          <div class="cr-k">PC + gemeente</div>
          <div class="cr-v" id="cr-delivery-postal">–</div>
        </div>
      </div>
    </div>

    <!-- Abonnement blok (ongewijzigd, zodat je bestaande JS blijft werken) -->
    <div class="cr-panel">
      <h3 class="cr-title">Abonnement</h3>

      <div class="sub-toggle">
        <div class="sub-toggle-label">Subscription</div>
        <button id="subscription-toggle" class="sub-toggle-switch sub-toggle-switch--on" type="button" aria-pressed="true">
          <span class="sub-toggle-knob"></span>
        </button>
      </div>

      <div id="deactivate-modal" class="modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-card">
          <h3 class="modal-title">Subscription deactiveren?</h3>
          <p class="modal-text">Dit is een UI-schakelaar (demo). In de echte flow gebeurt dit via support.</p>
          <div class="modal-actions">
            <button id="cancel-deactivate" class="btn-secondary" type="button">Annuleren</button>
            <button id="confirm-deactivate" class="btn-primary" type="button">Bevestigen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ View-only patch: vult de 3 velden die nu '-' blijven zonder app.js/server.js te wijzigen -->
  <script>
    (function () {
      const AUTH_TOKEN_KEY = "mypunctoo_auth_token";

      function getToken() {
        try { return window.localStorage.getItem(AUTH_TOKEN_KEY) || ""; } catch { return ""; }
      }

      async function authedFetch(url) {
        const token = getToken();
        const headers = {};
        if (token) headers["Authorization"] = "Bearer " + token;
        return fetch(url, { headers, cache: "no-cache" });
      }

      function setText(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        const v = (val === null || val === undefined || String(val).trim() === "") ? "–" : String(val);
        el.textContent = v;
      }

      function formatDateTimeISO(v) {
        if (!v) return "–";
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return String(v);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      }

      function fmtStreetLine(street, box) {
        const st = String(street || "").trim();
        const bx = String(box || "").trim();
        if (!st && !bx) return "–";
        return st + (bx ? ` - ${bx}` : "");
      }

      function fmtPcCityLine(postal, city) {
        const pc = String(postal || "").trim();
        const ct = String(city || "").trim();
        if (!pc && !ct) return "–";
        return pc + (ct ? ` - ${ct}` : "");
      }

      async function fillExtraFields() {
        try {
          // 1) Contact e-mail = login mail via /api/me (bestaat al)
          try {
            const rMe = await authedFetch("/api/me");
            const me = await rMe.json().catch(() => ({}));
            if (rMe.ok && me && me.ok && me.user && me.user.email) {
              setText("cr-contact-email", me.user.email);
            }
          } catch {}

          // 2) Account aangemaakt + delivery bedrijfsnaam via /api/company (bestaat al)
          const rC = await authedFetch("/api/company");
          const cc = await rC.json().catch(() => ({}));
          if (!rC.ok || !cc || !cc.ok || !cc.company) return;

          const c = cc.company;

          // Account aangemaakt = companies.created_at
          setText("cr-created-at", formatDateTimeISO(c.created_at));

          // Bedrijfsnaam levering = dezelfde als facturatie (companies.name)
          setText("cr-delivery-name", c.name);

          // BONUS: zetel/levering lijnen correct (bus + gemeente op dezelfde lijn)
          // (overschrijft wat app.js eventueel al gezet heeft, maar met correcte opmaak)
          setText("cr-registered-street", fmtStreetLine(c.registered_street, c.registered_box));
          setText("cr-registered-postal", fmtPcCityLine(c.registered_postal_code, c.registered_city));

          // levering fallback naar zetel als leeg
          const deliveryEmpty =
            !String(c.delivery_street || "").trim() &&
            !String(c.delivery_box || "").trim() &&
            !String(c.delivery_postal_code || "").trim() &&
            !String(c.delivery_city || "").trim();

          const delStreet = deliveryEmpty ? c.registered_street : c.delivery_street;
          const delBox = deliveryEmpty ? c.registered_box : c.delivery_box;
          const delPostal = deliveryEmpty ? c.registered_postal_code : c.delivery_postal_code;
          const delCity = deliveryEmpty ? c.registered_city : c.delivery_city;

          setText("cr-delivery-street", fmtStreetLine(delStreet, delBox));
          setText("cr-delivery-postal", fmtPcCityLine(delPostal, delCity));
        } catch {}
      }

      // run iets later zodat app.js eerst zijn hydrate kan doen
      setTimeout(fillExtraFields, 50);
    })();
  </script>
</section>
