<section class="card">
  <div class="client-header-row">
    <div>
      <h1 class="card-title">Klantfiche</h1>
      <p class="card-text">
        Dit is de officiële klantfiche van je bedrijf in <strong>MyPunctoo</strong>.
        Deze gegevens worden gebruikt voor <strong>abonnement</strong> en <strong>facturen</strong> en zijn niet rechtstreeks aanpasbaar in het portaal.
      </p>
    </div>

    <div class="client-status">
      <span class="client-status-label">Status</span>
      <span class="client-status-badge client-status-badge--active" id="client-status-badge">Actief</span>

      <div class="client-status-meta" id="client-status-meta">
        Account aangemaakt: <strong>–</strong><br>
        Klantnummer: <strong>–</strong>
      </div>
    </div>
  </div>

  <!-- Rij 1 -->
  <div class="client-grid">
    <div class="client-block">
      <h2 class="client-block-title">Basisgegevens</h2>

      <div class="client-row">
        <div class="client-label">Bedrijfsnaam</div>
        <div class="client-value" id="cr-name">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Ondernemingsnummer</div>
        <div class="client-value" id="cr-vat-number">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Klantnummer</div>
        <div class="client-value" id="cr-customer-number">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Website</div>
        <div class="client-value" id="cr-website">–</div>
      </div>
    </div>

    <div class="client-block">
      <h2 class="client-block-title">Contact & facturatie</h2>

      <div class="client-row">
        <div class="client-label">Contactpersoon (zetel)</div>
        <div class="client-value" id="cr-registered-contact">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Facturatie e-mail</div>
        <div class="client-value" id="cr-billing-email">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Referentie / PO</div>
        <div class="client-value" id="cr-billing-reference">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Leveringscontact</div>
        <div class="client-value" id="cr-delivery-contact">–</div>
      </div>
    </div>
  </div>

  <!-- Rij 2 -->
  <div class="client-grid" style="margin-top: 18px;">
    <div class="client-block">
      <h2 class="client-block-title">Maatschappelijke zetel</h2>

      <div class="client-row">
        <div class="client-label">Straat + nummer</div>
        <div class="client-value" id="cr-registered-street">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Bus</div>
        <div class="client-value" id="cr-registered-box">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Postcode</div>
        <div class="client-value" id="cr-registered-postal">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Gemeente</div>
        <div class="client-value" id="cr-registered-city">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Landcode</div>
        <div class="client-value" id="cr-registered-country">–</div>
      </div>
    </div>

    <div class="client-block">
      <h2 class="client-block-title">Facturatie-adres</h2>

      <div class="client-row">
        <div class="client-label">Straat + nummer</div>
        <div class="client-value" id="cr-billing-street">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Bus</div>
        <div class="client-value" id="cr-billing-box">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Postcode</div>
        <div class="client-value" id="cr-billing-postal">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Gemeente</div>
        <div class="client-value" id="cr-billing-city">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Landcode</div>
        <div class="client-value" id="cr-billing-country">–</div>
      </div>
    </div>
  </div>

  <!-- Rij 3 -->
  <div class="client-grid" style="margin-top: 18px;">
    <div class="client-block">
      <h2 class="client-block-title">Leveringsadres</h2>

      <div class="client-row">
        <div class="client-label">Straat + nummer</div>
        <div class="client-value" id="cr-delivery-street">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Bus</div>
        <div class="client-value" id="cr-delivery-box">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Postcode</div>
        <div class="client-value" id="cr-delivery-postal">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Gemeente</div>
        <div class="client-value" id="cr-delivery-city">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Landcode</div>
        <div class="client-value" id="cr-delivery-country">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Opmerking</div>
        <div class="client-value" id="cr-delivery-note">–</div>
      </div>
    </div>

    <div class="client-block">
      <h2 class="client-block-title">Samengestelde adressen</h2>

      <div class="client-row">
        <div class="client-label">Zetel (samenvatting)</div>
        <div class="client-value" id="cr-registered-address">–</div>
      </div>

      <div class="client-row">
        <div class="client-label">Facturatie (samenvatting)</div>
        <div class="client-value" id="cr-billing-address">–</div>
      </div>
    </div>
  </div>

  <div class="client-contact">
    <p class="client-contact-text">
      Wijziging nodig? Neem contact op met support.
    </p>
    <a class="client-contact-btn" href="mailto:support@mypunctoo.com">
      Wijziging aanvragen
    </a>
  </div>
</section>

<script>
(function () {
  const AUTH_TOKEN_KEY = "mypunctoo_auth_token";

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function norm(v) {
    if (v === null || v === undefined) return "";
    const s = String(v).trim();
    return s;
  }

  function coalesce(...vals) {
    for (const v of vals) {
      const s = norm(v);
      if (s) return s;
    }
    return "";
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    const v = norm(value);
    el.textContent = v ? v : "–";
  }

  function formatDateTimeISO(v) {
    if (!v) return "–";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return String(v);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  async function apiFetch(url, opts = {}) {
    const token = window.localStorage.getItem(AUTH_TOKEN_KEY) || "";
    const headers = Object.assign({}, opts.headers || {});
    if (token) headers["Authorization"] = `Bearer ${token}`;
    return fetch(url, Object.assign({}, opts, { headers }));
  }

  function hasAnyDeliveryAddress(c) {
    return !!(
      norm(c.delivery_street) ||
      norm(c.delivery_box) ||
      norm(c.delivery_postal_code) ||
      norm(c.delivery_city)
    );
  }

  async function hydrate() {
    try {
      const res = await apiFetch("/api/company", { cache: "no-cache" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) throw new Error(data.error || "Kon bedrijf niet laden.");

      const c = data.company || {};

      // Meta (source of truth)
      const metaEl = document.getElementById("client-status-meta");
      if (metaEl) {
        const created = formatDateTimeISO(c.created_at);
        const custNo = c.customer_number ?? "–";
        metaEl.innerHTML =
          `Account aangemaakt: <strong>${escapeHtml(created)}</strong><br>` +
          `Klantnummer: <strong>${escapeHtml(custNo)}</strong>`;
      }

      // Basis
      setText("cr-name", coalesce(c.name, c.company_name));
      setText("cr-vat-number", c.vat_number); // inhoud = ondernemingsnummer
      setText("cr-customer-number", c.customer_number);
      setText("cr-website", c.website);

      // Contact/facturatie
      const regContact = coalesce(c.registered_contact_person);
      const delContact = coalesce(c.delivery_contact_person, regContact); // ✅ fallback
      setText("cr-registered-contact", regContact);
      setText("cr-billing-email", c.billing_email);
      setText("cr-billing-reference", c.billing_reference);
      setText("cr-delivery-contact", delContact);

      // Zetel adres
      setText("cr-registered-street", c.registered_street);
      setText("cr-registered-box", c.registered_box);
      setText("cr-registered-postal", c.registered_postal_code);
      setText("cr-registered-city", c.registered_city);
      setText("cr-registered-country", c.registered_country_code);

      // Facturatie adres (exacte DB kolommen)
      setText("cr-billing-street", c.billing_street);
      setText("cr-billing-box", c.billing_box);
      setText("cr-billing-postal", c.billing_postal_code);
      setText("cr-billing-city", c.billing_city);
      setText("cr-billing-country", c.billing_country_code);

      // Levering: als NULL -> fallback naar zetel
      const dStreet  = coalesce(c.delivery_street, c.registered_street);
      const dBox     = coalesce(c.delivery_box, c.registered_box);
      const dPostal  = coalesce(c.delivery_postal_code, c.registered_postal_code);
      const dCity    = coalesce(c.delivery_city, c.registered_city);

      setText("cr-delivery-street", dStreet);
      setText("cr-delivery-box", dBox);
      setText("cr-delivery-postal", dPostal);
      setText("cr-delivery-city", dCity);

      // Country voor levering: gebruik de bestaande registered_country_code (België-only)
      setText("cr-delivery-country", coalesce(c.registered_country_code));

      // Opmerking: bepaal “afwijkend” zonder delivery_is_different kolom
      setText(
        "cr-delivery-note",
        hasAnyDeliveryAddress(c) ? "Afwijkend leveringsadres" : "Leveringsadres = maatschappelijke zetel"
      );

      // Samengestelde adressen (bestaan in jouw tabel)
      setText("cr-registered-address", c.registered_address);
      setText("cr-billing-address", c.billing_address);

    } catch (e) {
      console.warn(e);
    }
  }

  hydrate();
})();
</script>

