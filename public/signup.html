<!doctype html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyPunctoo | Aanmelden</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
<div class="auth-wrap">
  <div class="auth-card">
    <div class="auth-main">

      <div class="brand-row">
        <a href="/" class="brand">
          <img src="/assets/mypunctoo_logo_opwit.png" alt="MyPunctoo logo" class="brand-logo">
        </a>
        <div class="auth-switch">
          Heb je al een account?
          <a href="/login">Meld je aan</a>
        </div>
      </div>

      <h2 class="auth-title">Stel je MyPunctoo-dashboard in</h2>

      <div class="step-indicator">
        <div class="step-pill step-pill-1 active"><span>1</span> Account</div>
        <div class="step-divider"></div>
        <div class="step-pill step-pill-2"><span>2</span> Bedrijfsgegevens</div>
        <div class="step-divider"></div>
        <div class="step-pill step-pill-3"><span>3</span> Bevestiging</div>
      </div>

      <div id="formError" class="form-error"></div>
      <div id="formStatus" class="form-status"></div>

      <form id="signupForm" novalidate>
        <input type="hidden" id="signup_token" />

        <!-- STEP 1 -->
        <div id="step-1" class="form-step active">
          <h3 class="form-section-title">Account</h3>

          <div class="field">
            <label>E-mail *</label>
            <input id="email" type="email" required autocomplete="email">
          </div>

          <div class="field-row">
            <div class="field">
              <label>Wachtwoord *</label>
              <input id="password" type="password" required autocomplete="new-password">
              <div class="help-text">Minstens 8 tekens.</div>
            </div>
            <div class="field">
              <label>Bevestig wachtwoord *</label>
              <input id="passwordConfirm" type="password" required autocomplete="new-password">
            </div>
          </div>

          <div class="help-text">
            Je bevestigt de bestelling in de laatste stap.
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step-2" class="form-step">
          <h3 class="form-section-title">Bedrijf</h3>

          <div class="field">
            <label>Bedrijfsnaam *</label>
            <input id="companyName" required autocomplete="organization">
          </div>

          <div class="field">
            <label>Ondernemingsnummer *</label>
            <input id="vat_number" required placeholder="">
            <div class="help-text help-text-normal" id="vatHelp">
              Verplicht formaat: <strong>0123.456.789</strong>
            </div>
            <div class="soft-warning" id="vatWarn"></div>
          </div>

          <div class="field">
            <label>Website (optioneel)</label>
            <input id="website" type="url" placeholder="https://voorbeeld.be">
            <div class="help-text">Laat leeg indien niet van toepassing.</div>
          </div>

          <h3 class="form-section-title">Maatschappelijke zetel</h3>

          <div class="field">
            <label>Contactpersoon *</label>
            <input id="registered_contact_person" required autocomplete="name">
          </div>

          <div class="field">
            <label>Straat + nummer *</label>
            <input id="registered_street" required autocomplete="street-address">
          </div>

          <div class="field">
            <label>Bus (optioneel)</label>
            <input id="registered_box">
          </div>

          <div class="field-row">
            <div class="field">
              <label>Postcode *</label>
              <input id="registered_postal_code" required autocomplete="postal-code">
            </div>
            <div class="field">
              <label>Gemeente *</label>
              <input id="registered_city" required autocomplete="address-level2">
            </div>
          </div>

          <h3 class="form-section-title">Facturatie</h3>

          <div class="field">
            <label>Facturatie e-mail *</label>
            <input id="billing_email" type="email" required>
          </div>

          <div class="field">
            <label>Referentie / PO (optioneel)</label>
            <input id="billing_reference">
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="delivery_is_different">
            <span>Leveringsadres voor MyPunctoo-plaat is anders dan de maatschappelijke zetel</span>
          </div>

          <div id="deliveryBlock" style="display:none;">
            <h3 class="form-section-title">Leveringsadres</h3>

            <div class="field">
              <label>Contactpersoon *</label>
              <input id="delivery_contact_person">
            </div>

            <div class="field">
              <label>Straat + nummer *</label>
              <input id="delivery_street">
            </div>

            <div class="field">
              <label>Bus (optioneel)</label>
              <input id="delivery_box">
            </div>

            <div class="field-row">
              <div class="field">
                <label>Postcode *</label>
                <input id="delivery_postal_code">
              </div>
              <div class="field">
                <label>Gemeente *</label>
                <input id="delivery_city">
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div id="step-3" class="form-step">
          <h3 class="form-section-title">Bevestig je bestelling</h3>

          <!-- (Deze pricing UI laat ik staan zoals je had) -->
          <div class="checkout-box">
            <div class="checkout-row">
              <div>Opstartkost</div>
              <div><strong>€49</strong></div>
            </div>

            <div class="checkout-row">
              <div>Extra platen</div>
              <div class="qty-row">
                <button type="button" class="qty-btn" id="platesMinus">−</button>
                <input id="extraPlates" class="qty-input" value="0" inputmode="numeric">
                <button type="button" class="qty-btn" id="platesPlus">+</button>
              </div>
            </div>

            <div class="checkout-row checkout-row-total">
              <div>Totaal vandaag</div>
              <div><strong id="totalToday">€49</strong></div>
            </div>
          </div>

          <div class="checkbox-row checkbox-row-strong">
            <input type="checkbox" id="salesTerms" required>
            <span>Ik heb de verkoopvoorwaarden gelezen en ga akkoord</span>
          </div>
        </div>

        <!-- NAV -->
        <div class="form-navigation">
          <div class="nav-left">
            <div class="nav-hint" id="navHint">Stap 1 van 3</div>
          </div>

          <div class="nav-right">
            <button type="button" id="backBtn" class="btn-secondary" style="display:none;">← Terug</button>
            <button type="button" id="nextBtn" class="btn-primary">Volgende →</button>
            <button type="button" id="confirmBtn" class="btn-primary" style="display:none;">Bestelling bevestigen</button>
          </div>
        </div>
      </form>
    </div>

    <div class="auth-aside" aria-hidden="true"></div>
  </div>
</div>

<script>
(function () {
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');

  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  const confirmBtn = document.getElementById('confirmBtn');
  const navHint = document.getElementById('navHint');

  const pill1 = document.querySelector('.step-pill-1');
  const pill2 = document.querySelector('.step-pill-2');
  const pill3 = document.querySelector('.step-pill-3');

  const formError = document.getElementById('formError');
  const formStatus = document.getElementById('formStatus');

  const signupTokenEl = document.getElementById('signup_token');
  const emailEl = document.getElementById('email');
  const passwordEl = document.getElementById('password');
  const passwordConfirmEl = document.getElementById('passwordConfirm');

  const companyNameEl = document.getElementById('companyName');
  const ondernemingsnrEl = document.getElementById('vat_number');
  const websiteEl = document.getElementById('website');

  const regContactEl = document.getElementById('registered_contact_person');
  const regStreetEl = document.getElementById('registered_street');
  const regBoxEl = document.getElementById('registered_box');
  const regPostalEl = document.getElementById('registered_postal_code');
  const regCityEl = document.getElementById('registered_city');

  const billingEmailEl = document.getElementById('billing_email');
  const billingRefEl = document.getElementById('billing_reference');

  const deliveryCheckbox = document.getElementById('delivery_is_different');
  const deliveryBlock = document.getElementById('deliveryBlock');

  const delContactEl = document.getElementById('delivery_contact_person');
  const delStreetEl = document.getElementById('delivery_street');
  const delBoxEl = document.getElementById('delivery_box');
  const delPostalEl = document.getElementById('delivery_postal_code');
  const delCityEl = document.getElementById('delivery_city');

  const vatWarnEl = document.getElementById('vatWarn');

  const platesMinus = document.getElementById('platesMinus');
  const platesPlus = document.getElementById('platesPlus');
  const extraPlatesEl = document.getElementById('extraPlates');
  const salesTermsEl = document.getElementById('salesTerms');
  const totalTodayEl = document.getElementById('totalToday');

  const STARTUP_FEE = 49;
  const EXTRA_PLATE_PRICE = 39;

  let currentStep = 1;

  function showError(msg) {
    if (!formError) return;
    formError.textContent = msg || '';
    formError.style.display = msg ? 'block' : 'none';
  }

  function showStatus(msg) {
    if (!formStatus) return;
    formStatus.textContent = msg || '';
    formStatus.style.display = msg ? 'block' : 'none';
  }

  function setPills(step) {
    pill1.classList.toggle('active', step === 1);
    pill2.classList.toggle('active', step === 2);
    pill3.classList.toggle('active', step === 3);
  }

  function go(step) {
    currentStep = step;

    step1.classList.toggle('active', step === 1);
    step2.classList.toggle('active', step === 2);
    step3.classList.toggle('active', step === 3);

    backBtn.style.display = step === 1 ? 'none' : 'inline-flex';
    nextBtn.style.display = step === 3 ? 'none' : 'inline-flex';
    confirmBtn.style.display = step === 3 ? 'inline-flex' : 'none';

    navHint.textContent = `Stap ${step} van 3`;
    setPills(step);

    showError('');
    showStatus('');
  }

  function norm(v) {
    if (v === null || v === undefined) return '';
    return String(v).trim();
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
  }

  function clamp(n, min, max) {
    const x = Number(n);
    if (Number.isNaN(x)) return min;
    return Math.max(min, Math.min(max, x));
  }

  function toIntSafe(v, fallback) {
    const n = parseInt(String(v || ''), 10);
    return Number.isNaN(n) ? fallback : n;
  }

  function updateTotal() {
    const qty = clamp(toIntSafe(extraPlatesEl.value, 0), 0, 99);
    const total = STARTUP_FEE + (qty * EXTRA_PLATE_PRICE);
    totalTodayEl.textContent = `€${total}`;
  }

  function requireFilled(label, v) {
    if (norm(v)) return true;
    showError(`${label} is verplicht.`);
    return false;
  }

  function validateVatFormat(vat) {
    const pattern = /^0\d{3}\.\d{3}\.\d{3}$/;
    return pattern.test(String(vat || '').trim());
  }

  function buildStep2Payload() {
    const payload = {
      signup_token: norm(signupTokenEl.value),
      company_name: norm(companyNameEl.value),
      vat_number: norm(ondernemingsnrEl.value),
      website: norm(websiteEl.value),

      registered_contact_person: norm(regContactEl.value),
      registered_street: norm(regStreetEl.value),
      registered_box: norm(regBoxEl.value),
      registered_postal_code: norm(regPostalEl.value),
      registered_city: norm(regCityEl.value),

      billing_email: norm(billingEmailEl.value),
      billing_reference: norm(billingRefEl.value),

      delivery_is_different: !!deliveryCheckbox.checked,
      delivery_contact_person: norm(delContactEl.value),
      delivery_street: norm(delStreetEl.value),
      delivery_box: norm(delBoxEl.value),
      delivery_postal_code: norm(delPostalEl.value),
      delivery_city: norm(delCityEl.value)
    };

    if (!payload.delivery_is_different) {
      payload.delivery_contact_person = '';
      payload.delivery_street = '';
      payload.delivery_box = '';
      payload.delivery_postal_code = '';
      payload.delivery_city = '';
    }

    return payload;
  }

  function buildStep3Payload() {
    return { signup_token: norm(signupTokenEl.value) };
  }

  deliveryCheckbox.addEventListener('change', () => {
    const on = !!deliveryCheckbox.checked;
    deliveryBlock.style.display = on ? 'block' : 'none';
  });

  platesMinus?.addEventListener('click', () => {
    const qty = clamp(toIntSafe(extraPlatesEl.value, 0) - 1, 0, 99);
    extraPlatesEl.value = String(qty);
    updateTotal();
  });

  platesPlus?.addEventListener('click', () => {
    const qty = clamp(toIntSafe(extraPlatesEl.value, 0) + 1, 0, 99);
    extraPlatesEl.value = String(qty);
    updateTotal();
  });

  extraPlatesEl?.addEventListener('input', () => updateTotal());

  backBtn.onclick = () => {
    if (currentStep === 2) return go(1);
    if (currentStep === 3) return go(2);
  };

  nextBtn.onclick = async () => {
    showError('');
    showStatus('');

    if (currentStep === 1) {
      const email = norm(emailEl.value).toLowerCase();
      const pw = String(passwordEl.value || '');
      const pw2 = String(passwordConfirmEl.value || '');

      if (!requireFilled('E-mail', email)) return;
      if (!isValidEmail(email)) { showError('Ongeldig e-mailadres.'); return; }
      if (!requireFilled('Wachtwoord', pw)) return;
      if (pw.length < 8) { showError('Wachtwoord moet minstens 8 tekens bevatten.'); return; }
      if (pw !== pw2) { showError('Wachtwoorden komen niet overeen.'); return; }

      showStatus('Account aanmaken...');
      try {
        const r = await fetch('/api/signup/step1', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: pw })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) {
          showStatus('');
          showError(data.error || 'Kon account niet starten.');
          return;
        }

        signupTokenEl.value = data.signup_token || '';
        sessionStorage.setItem('signup_token', signupTokenEl.value);

        showStatus('');
        go(2);
      } catch (e) {
        showStatus('');
        showError('Netwerkfout.');
      }
      return;
    }

    if (currentStep === 2) {
      const payload = buildStep2Payload();

      if (!requireFilled('Bedrijfsnaam', payload.company_name)) return;

      if (!requireFilled('Ondernemingsnummer', payload.vat_number)) return;
      if (!validateVatFormat(payload.vat_number)) {
        vatWarnEl.textContent = 'Formaat verplicht: 0123.456.789';
        showError('Ondernemingsnummer: verplicht formaat 0123.456.789');
        return;
      } else {
        vatWarnEl.textContent = '';
      }

      if (!requireFilled('Contactpersoon', payload.registered_contact_person)) return;
      if (!requireFilled('Straat + nummer', payload.registered_street)) return;
      if (!requireFilled('Postcode', payload.registered_postal_code)) return;
      if (!requireFilled('Gemeente', payload.registered_city)) return;

      if (!payload.billing_email || !isValidEmail(payload.billing_email)) {
        showError('Geef een geldig facturatie e-mailadres op.');
        return;
      }

      if (payload.delivery_is_different) {
        if (!requireFilled('Levering contactpersoon', payload.delivery_contact_person)) return;
        if (!requireFilled('Levering straat + nummer', payload.delivery_street)) return;
        if (!requireFilled('Levering postcode', payload.delivery_postal_code)) return;
        if (!requireFilled('Levering gemeente', payload.delivery_city)) return;
      }

      showStatus('Bedrijfsgegevens opslaan...');
      try {
        const r = await fetch('/api/signup/step2', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) {
          showStatus('');
          showError(data.error || 'Kon bedrijfsgegevens niet opslaan.');
          return;
        }

        showStatus('');
        go(3);
      } catch (e) {
        showStatus('');
        showError('Netwerkfout.');
      }
    }
  };

  confirmBtn.onclick = async () => {
    showError('');
    showStatus('');

    const qty = clamp(toIntSafe(extraPlatesEl.value, 0), 0, 99);
    extraPlatesEl.value = String(qty);
    updateTotal();

    if (!salesTermsEl.checked) {
      showError('Gelieve de verkoopvoorwaarden te aanvaarden.');
      return;
    }

    showStatus('Bestelling bevestigen...');
    try {
      const r = await fetch('/api/signup/step3', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(buildStep3Payload())
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data.ok) {
        showStatus('');
        showError(data.error || 'Bevestiging mislukt.');
        return;
      }

      sessionStorage.removeItem('signup_token');
      window.location.href = data.redirectUrl || '/login';
    } catch (e) {
      showStatus('');
      showError('Netwerkfout.');
    }
  };

  // restore token if user reloads in step2/3
  const stored = sessionStorage.getItem('signup_token');
  if (stored && !signupTokenEl.value) signupTokenEl.value = stored;

  go(1);
  updateTotal();
})();
</script>
</body>
</html>
