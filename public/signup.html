<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyPunctoo | Signup</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/auth.css">
</head>

<body>
<div class="auth-wrap">
  <div class="auth-card">
    <div class="auth-main">

      <div class="brand-row">
        <a href="/" class="brand">
          <img src="/assets/mypunctoo_logo_opwit.png" alt="MyPunctoo logo" class="brand-logo">
        </a>
        <div class="auth-switch">
          Already have an account?
          <a href="/login">Sign in</a>
        </div>
      </div>

      <h2 class="auth-title">Create your MyPunctoo workspace</h2>
      <p class="auth-subtitle">
        Two short steps to connect your company to a compliant digital time tracking system.
      </p>

      <div class="step-indicator">
        <div class="step-pill step-pill-1 active"><span>1</span> HR contact</div>
        <div class="step-divider"></div>
        <div class="step-pill step-pill-2"><span>2</span> Company details</div>
      </div>

      <div id="formError" class="form-error"></div>
      <div id="formStatus" class="form-status"></div>

      <form id="signupForm" novalidate>
        <input type="hidden" id="signupToken">

        <!-- STEP 1 -->
        <div id="step-1" class="form-step active">
          <h3 class="form-section-title">Contact person (HR)</h3>

          <div class="field-row">
            <div class="field">
              <label>First name *</label>
              <input id="firstName" required autocomplete="given-name">
            </div>
            <div class="field">
              <label>Last name *</label>
              <input id="lastName" required autocomplete="family-name">
            </div>
          </div>

          <div class="field">
            <label>Work e-mail *</label>
            <input id="email" type="email" required autocomplete="email">
          </div>

          <div class="field-row">
            <div class="field">
              <label>Password *</label>
              <input id="password" type="password" required autocomplete="new-password">
            </div>
            <div class="field">
              <label>Confirm password *</label>
              <input id="passwordConfirm" type="password" required autocomplete="new-password">
            </div>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="terms" required>
            <span>I agree to the Terms & Conditions and Privacy Policy</span>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step-2" class="form-step">

          <h3 class="form-section-title">Company</h3>

          <div class="field">
            <label>Company name *</label>
            <input id="companyName" required autocomplete="organization">
          </div>

          <div class="field">
            <label>Enterprise / EU business number *</label>
            <input id="enterpriseNumber" required>
            <div class="help-text">
              Belgian companies: ondernemingsnummer. EU companies: business/VAT number.
            </div>
          </div>

          <div class="field">
            <label>Website (optional)</label>
            <input id="website" type="url" placeholder="https://example.com">
            <div class="help-text">Leave empty if not applicable.</div>
          </div>

          <h3 class="form-section-title">Registered address</h3>

          <div class="field">
            <label>Street + number *</label>
            <input id="regStreet" required autocomplete="street-address">
          </div>

          <div class="field">
            <label>Box (optional)</label>
            <input id="regBox">
          </div>

          <div class="field-row">
            <div class="field">
              <label>Postal code *</label>
              <input id="regPostal" required autocomplete="postal-code">
            </div>
            <div class="field">
              <label>City *</label>
              <input id="regCity" required autocomplete="address-level2">
            </div>
          </div>

          <div class="field">
            <label>Country *</label>
            <select id="regCountry" required autocomplete="country">
              <option value="">Select country</option>
              <option value="BE">Belgium</option>
              <option value="NL">Netherlands</option>
              <option value="FR">France</option>
              <option value="DE">Germany</option>
              <option value="LU">Luxembourg</option>
              <option value="ES">Spain</option>
              <option value="IT">Italy</option>
            </select>
          </div>

          <h3 class="form-section-title">Billing</h3>

          <div class="field">
            <label>Billing e-mail *</label>
            <input id="billingEmail" type="email" required>
          </div>

          <div class="field">
            <label>Billing reference / PO (optional)</label>
            <input id="billingReference">
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="deliveryDifferent">
            <span>Delivery address is different from registered address</span>
          </div>

          <div id="deliveryBlock" style="display:none;">
            <h3 class="form-section-title">Delivery address</h3>

            <div class="field">
              <label>Street + number *</label>
              <input id="delStreet">
            </div>

            <div class="field">
              <label>Box (optional)</label>
              <input id="delBox">
            </div>

            <div class="field-row">
              <div class="field">
                <label>Postal code *</label>
                <input id="delPostal">
              </div>
              <div class="field">
                <label>City *</label>
                <input id="delCity">
              </div>
            </div>

            <div class="field">
              <label>Country *</label>
              <select id="delCountry">
                <option value="">Select country</option>
                <option value="BE">Belgium</option>
                <option value="NL">Netherlands</option>
                <option value="FR">France</option>
                <option value="DE">Germany</option>
                <option value="LU">Luxembourg</option>
                <option value="ES">Spain</option>
                <option value="IT">Italy</option>
              </select>
            </div>
          </div>
        </div>

        <!-- NAV -->
        <div class="form-navigation">
          <button type="button" id="backBtn" style="display:none;">← Back</button>
          <button type="button" id="nextBtn">Next →</button>
          <button type="button" id="createBtn" style="display:none;">Create account</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  const createBtn = document.getElementById('createBtn');

  const formError = document.getElementById('formError');
  const formStatus = document.getElementById('formStatus');
  const signupTokenEl = document.getElementById('signupToken');

  const firstNameEl = document.getElementById('firstName');
  const lastNameEl = document.getElementById('lastName');
  const emailEl = document.getElementById('email');
  const passwordEl = document.getElementById('password');
  const passwordConfirmEl = document.getElementById('passwordConfirm');
  const termsEl = document.getElementById('terms');

  const companyNameEl = document.getElementById('companyName');
  const enterpriseNumberEl = document.getElementById('enterpriseNumber');
  const websiteEl = document.getElementById('website');

  const regStreetEl = document.getElementById('regStreet');
  const regBoxEl = document.getElementById('regBox');
  const regPostalEl = document.getElementById('regPostal');
  const regCityEl = document.getElementById('regCity');
  const regCountryEl = document.getElementById('regCountry');

  const billingEmailEl = document.getElementById('billingEmail');
  const billingReferenceEl = document.getElementById('billingReference');

  const deliveryCheckbox = document.getElementById('deliveryDifferent');
  const deliveryBlock = document.getElementById('deliveryBlock');

  const delStreetEl = document.getElementById('delStreet');
  const delBoxEl = document.getElementById('delBox');
  const delPostalEl = document.getElementById('delPostal');
  const delCityEl = document.getElementById('delCity');
  const delCountryEl = document.getElementById('delCountry');

  function showError(msg) {
    formError.textContent = msg || '';
    formError.style.display = msg ? 'block' : 'none';
  }
  function showStatus(msg) {
    formStatus.textContent = msg || '';
    formStatus.style.display = msg ? 'block' : 'none';
  }

  function go(step) {
    step1.classList.toggle('active', step === 1);
    step2.classList.toggle('active', step === 2);
    backBtn.style.display = step === 2 ? 'inline-flex' : 'none';
    nextBtn.style.display = step === 1 ? 'inline-flex' : 'none';
    createBtn.style.display = step === 2 ? 'inline-flex' : 'none';
    showError('');
    showStatus('');
  }

  nextBtn.onclick = async () => {
    showError('');
    showStatus('');

    const payload = {
      first_name: firstNameEl.value.trim(),
      last_name: lastNameEl.value.trim(),
      email: emailEl.value.trim(),
      password: passwordEl.value,
      password_confirm: passwordConfirmEl.value,
      terms: !!termsEl.checked
    };

    if (!payload.first_name || !payload.last_name || !payload.email || !payload.password || !payload.password_confirm) {
      showError('Please fill in all required fields.');
      return;
    }

    showStatus('Creating your HR account...');
    try {
      const r = await fetch('/api/signup/step1', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!data.ok) {
        showStatus('');
        showError(data.error || 'Signup failed.');
        return;
      }

      signupTokenEl.value = data.signupToken;
      // default billing email = HR email
      billingEmailEl.value = payload.email;

      showStatus('');
      go(2);
    } catch (e) {
      showStatus('');
      showError('Network error.');
    }
  };

  backBtn.onclick = () => go(1);

  // -------- Auto capitalization (except e-mail + passwords) --------
  const LOWER_WORDS = new Set(['de','der','den','van','von','da','di','la','le','du','des','of','and']);
  function toTitleCase(str) {
    const s = (str || '').trim();
    if (!s) return '';
    return s
      .toLowerCase()
      .split(/(\s+|-|')/g) // keep separators
      .map((part, idx) => {
        if (part.match(/^\s+|-|'$/)) return part; // separator
        if (idx !== 0 && LOWER_WORDS.has(part)) return part;
        // keep leading digits (e.g., "3M") readable
        return part.charAt(0).toUpperCase() + part.slice(1);
      })
      .join('');
  }

  function onBlurTitleCase(el) {
    el.addEventListener('blur', () => {
      el.value = toTitleCase(el.value);
    });
  }

  // Apply Title Case on blur for these fields:
  [
    firstNameEl, lastNameEl,
    companyNameEl,
    regStreetEl, regCityEl,
    billingReferenceEl,
    delStreetEl, delCityEl
  ].forEach(onBlurTitleCase);

  // Box fields: usually uppercase (bus A, B12)
  function onBlurUpper(el) {
    el.addEventListener('blur', () => {
      el.value = (el.value || '').trim().toUpperCase();
    });
  }
  [regBoxEl, delBoxEl].forEach(onBlurUpper);

  // Enterprise number: keep as entered but uppercase (EU prefixes)
  onBlurUpper(enterpriseNumberEl);

  // Website: trim only
  websiteEl.addEventListener('blur', () => {
    websiteEl.value = (websiteEl.value || '').trim();
  });

  // emails: never auto-capitalize; only trim
  [emailEl, billingEmailEl].forEach(el => {
    el.addEventListener('blur', () => {
      el.value = (el.value || '').trim();
    });
  });

  // Delivery toggle: show/hide + required
  deliveryCheckbox.addEventListener('change', () => {
    const on = deliveryCheckbox.checked;
    deliveryBlock.style.display = on ? 'block' : 'none';
    deliveryBlock.querySelectorAll('input,select').forEach(el => {
      on ? el.setAttribute('required', 'required') : el.removeAttribute('required');
      if (!on) el.value = '';
    });
  });

  // Create account (step 2)
  createBtn.onclick = async () => {
    showError('');
    showStatus('');

    const deliveryIsDifferent = !!deliveryCheckbox.checked;

    const payload = {
      signup_token: signupTokenEl.value,
      email: (emailEl.value || '').trim().toLowerCase(),
      password: passwordEl.value,

      company_name: companyNameEl.value.trim(),
      enterprise_number: enterpriseNumberEl.value.trim(),
      website: (websiteEl.value || '').trim(),

      registered_street: regStreetEl.value.trim(),
      registered_box: regBoxEl.value.trim(),
      registered_postal_code: regPostalEl.value.trim(),
      registered_city: regCityEl.value.trim(),
      registered_country_code: regCountryEl.value,

      billing_email: (billingEmailEl.value || '').trim().toLowerCase(),
      billing_reference: billingReferenceEl.value.trim(),

      delivery_is_different: deliveryIsDifferent,
      delivery_street: delStreetEl.value.trim(),
      delivery_box: delBoxEl.value.trim(),
      delivery_postal_code: delPostalEl.value.trim(),
      delivery_city: delCityEl.value.trim(),
      delivery_country_code: delCountryEl.value
    };

    // If delivery not different, clear delivery payload (server ignores anyway)
    if (!deliveryIsDifferent) {
      payload.delivery_street = '';
      payload.delivery_box = '';
      payload.delivery_postal_code = '';
      payload.delivery_city = '';
      payload.delivery_country_code = '';
    }

    showStatus('Creating your company workspace...');
    try {
      const r = await fetch('/api/signup/step2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!data.ok) {
        showStatus('');
        showError(data.error || 'Signup failed.');
        return;
      }
      window.location.href = data.redirectUrl || '/login';
    } catch (e) {
      showStatus('');
      showError('Network error.');
    }
  };

})();
</script>
</body>
</html>
