<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyPunctoo | Signup</title>

  <!-- Keep your existing styling assets -->
  <link rel="stylesheet" href="/css/auth.css" />
</head>
<body>

  <div class="auth-shell">
    <div class="auth-card">
      <div class="auth-header">
        <h1>Signup</h1>
        <p>Create your company account.</p>
      </div>

      <!-- status + errors -->
      <div id="statusLine" class="status-line" style="display:none;"></div>
      <div id="errorLine" class="error-line" style="display:none;"></div>

      <!-- hidden token across steps -->
      <input type="hidden" id="signup_token" value="" />

      <!-- STEP NAV -->
      <div class="stepper">
        <div class="stepper-item" id="stepDot1"><span>1</span><div>Account</div></div>
        <div class="stepper-item" id="stepDot2"><span>2</span><div>Company</div></div>
        <div class="stepper-item" id="stepDot3"><span>3</span><div>Confirm</div></div>
      </div>

      <!-- STEP 1 -->
      <section class="step" id="step1">
        <div class="field">
          <label>Email *</label>
          <input id="email" type="email" autocomplete="email" required />
        </div>

        <div class="field">
          <label>Password *</label>
          <input id="password" type="password" autocomplete="new-password" required />
          <div class="help-text help-text-normal">Minimum 8 characters.</div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnStep1Next">Next →</button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="step" id="step2" style="display:none;">
        <h2 class="section-title">Company details</h2>

        <div class="field">
          <label>Company name *</label>
          <input id="company_name" autocomplete="organization" required />
        </div>

        <div class="field">
          <label>Enterprise / VAT number (Belgium) *</label>
          <div class="prefix-input">
            <span class="prefix-badge">BE</span>
            <input id="vat_number" required />
          </div>
          <div class="help-text help-text-normal">
            Format required: <strong>BE 0123. 456. 789</strong>
          </div>
        </div>

        <div class="field">
          <label>Website (optional)</label>
          <input id="website" />
        </div>

        <hr class="divider" />

        <h2 class="section-title">Registered address</h2>

        <div class="field">
          <label>Contact person *</label>
          <input id="registered_contact_person" required />
        </div>

        <div class="field">
          <label>Street + number *</label>
          <input id="registered_street" required />
        </div>

        <div class="field">
          <label>Box (optional)</label>
          <input id="registered_box" />
        </div>

        <div class="field">
          <label>Postal code *</label>
          <input id="registered_postal_code" required />
        </div>

        <div class="field">
          <label>City *</label>
          <input id="registered_city" required />
        </div>

        <!-- BE-only; keep as hidden so backend never depends on user input -->
        <input type="hidden" id="registered_country_code" value="BE" />

        <hr class="divider" />

        <h2 class="section-title">Billing</h2>

        <div class="field">
          <label>Invoices sent to (email) *</label>
          <input id="billing_email" type="email" autocomplete="email" required />
        </div>

        <div class="field">
          <label>Billing reference / PO (optional)</label>
          <input id="billing_reference" />
        </div>

        <hr class="divider" />

        <div class="field checkbox-field">
          <label>
            <input type="checkbox" id="delivery_is_different" />
            Delivery address is different from registered address
          </label>
        </div>

        <div id="deliveryBlock" style="display:none;">
          <h2 class="section-title">Delivery address</h2>

          <div class="field">
            <label>Contact person *</label>
            <input id="delivery_contact_person" />
          </div>

          <div class="field">
            <label>Street + number *</label>
            <input id="delivery_street" />
          </div>

          <div class="field">
            <label>Box (optional)</label>
            <input id="delivery_box" />
          </div>

          <div class="field">
            <label>Postal code *</label>
            <input id="delivery_postal_code" />
          </div>

          <div class="field">
            <label>City *</label>
            <input id="delivery_city" />
          </div>

          <!-- BE-only hidden -->
          <input type="hidden" id="delivery_country_code" value="BE" />
        </div>

        <div class="actions">
          <button class="btn" id="btnStep2Back">← Back</button>
          <button class="btn primary" id="btnStep2Next">Next →</button>
        </div>
      </section>

      <!-- STEP 3 -->
      <section class="step" id="step3" style="display:none;">
        <h2 class="section-title">Confirm</h2>
        <div class="confirm-box" id="confirmBox"></div>

        <div class="actions">
          <button class="btn" id="btnStep3Back">← Back</button>
          <button class="btn primary" id="btnCreateAccount">Create account</button>
        </div>

        <div class="help-text help-text-normal" style="margin-top:10px;">
          By creating an account, you confirm your company data is correct.
        </div>
      </section>

    </div>
  </div>

<script>
  // -----------------------------
  // UI helpers
  // -----------------------------
  const $ = (id) => document.getElementById(id);

  function showError(msg) {
    const el = $("errorLine");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function showStatus(msg) {
    const el = $("statusLine");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function requireFilled(label, value) {
    if (value === null || value === undefined) value = "";
    const s = String(value).trim();
    if (!s) {
      showError(`Please fill in: ${label}`);
      return false;
    }
    return true;
  }

  function isValidEmail(s) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s || "").trim());
  }

  // Strict Belgium VAT format: "BE 0123. 456. 789"
  function isValidBEVat(s) {
    return /^BE\s0\d{3}\.\s\d{3}\.\s\d{3}$/.test(String(s || "").trim());
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatDateISO(d) {
    // Accept ISO strings from server; show YYYY-MM-DD
    if (!d) return "–";
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return String(d);
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const day = String(dt.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  // -----------------------------
  // Steps
  // -----------------------------
  let currentStep = 1;

  function setStepper(step) {
    for (let i = 1; i <= 3; i++) {
      const dot = $("stepDot" + i);
      if (!dot) continue;
      dot.classList.toggle("active", i === step);
      dot.classList.toggle("done", i < step);
    }
  }

  function go(step) {
    currentStep = step;
    showError("");
    showStatus("");
    $("step1").style.display = step === 1 ? "block" : "none";
    $("step2").style.display = step === 2 ? "block" : "none";
    $("step3").style.display = step === 3 ? "block" : "none";
    setStepper(step);
  }

  // Delivery toggle
  $("delivery_is_different").addEventListener("change", () => {
    $("deliveryBlock").style.display = $("delivery_is_different").checked ? "block" : "none";
  });

  // -----------------------------
  // Step 1 -> create draft
  // -----------------------------
  $("btnStep1Next").addEventListener("click", async () => {
    showError("");
    showStatus("");

    const email = $("email").value.trim().toLowerCase();
    const password = $("password").value;

    if (!requireFilled("Email", email)) return;
    if (!isValidEmail(email)) { showError("Invalid email."); return; }
    if (!requireFilled("Password", password)) return;
    if (String(password).length < 8) { showError("Password must be at least 8 characters."); return; }

    showStatus("Creating your signup draft...");

    try {
      const r = await fetch("/api/signup/step1", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data.ok) {
        showStatus("");
        showError(data.error || "Could not start signup.");
        return;
      }
      $("signup_token").value = data.signup_token;
      showStatus("");
      go(2);
    } catch (e) {
      showStatus("");
      showError("Network error.");
    }
  });

  // -----------------------------
  // Step 2 payload
  // -----------------------------
  function buildStep2Payload() {
    const deliveryDifferent = $("delivery_is_different").checked;

    const payload = {
      signup_token: $("signup_token").value.trim(),

      company_name: $("company_name").value.trim(),

      // BE-only
      country_code: "BE",

      vat_number: $("vat_number").value.trim(),
      website: $("website").value.trim() || null,

      registered_contact_person: $("registered_contact_person").value.trim(),
      registered_street: $("registered_street").value.trim(),
      registered_box: $("registered_box").value.trim() || null,
      registered_postal_code: $("registered_postal_code").value.trim(),
      registered_city: $("registered_city").value.trim(),
      registered_country_code: "BE",

      billing_email: $("billing_email").value.trim().toLowerCase(),
      billing_reference: $("billing_reference").value.trim() || null,

      delivery_is_different: deliveryDifferent
    };

    if (deliveryDifferent) {
      payload.delivery_contact_person = $("delivery_contact_person").value.trim();
      payload.delivery_street = $("delivery_street").value.trim();
      payload.delivery_box = $("delivery_box").value.trim() || null;
      payload.delivery_postal_code = $("delivery_postal_code").value.trim();
      payload.delivery_city = $("delivery_city").value.trim();
      payload.delivery_country_code = "BE";
    }

    return payload;
  }

  function fillConfirmBox(payload) {
    const lines = [];
    lines.push(`<div><strong>Company:</strong> ${escapeHtml(payload.company_name)}</div>`);
    lines.push(`<div><strong>VAT:</strong> ${escapeHtml(payload.vat_number)}</div>`);
    lines.push(`<div><strong>Registered contact:</strong> ${escapeHtml(payload.registered_contact_person)}</div>`);
    lines.push(`<div><strong>Registered address:</strong> ${escapeHtml(payload.registered_street)} ${escapeHtml(payload.registered_box || "")}, ${escapeHtml(payload.registered_postal_code)} ${escapeHtml(payload.registered_city)}</div>`);
    lines.push(`<div><strong>Billing email:</strong> ${escapeHtml(payload.billing_email)}</div>`);
    if (payload.billing_reference) lines.push(`<div><strong>Billing reference:</strong> ${escapeHtml(payload.billing_reference)}</div>`);
    if (payload.website) lines.push(`<div><strong>Website:</strong> ${escapeHtml(payload.website)}</div>`);

    if (payload.delivery_is_different) {
      lines.push(`<hr />`);
      lines.push(`<div><strong>Delivery contact:</strong> ${escapeHtml(payload.delivery_contact_person)}</div>`);
      lines.push(`<div><strong>Delivery address:</strong> ${escapeHtml(payload.delivery_street)} ${escapeHtml(payload.delivery_box || "")}, ${escapeHtml(payload.delivery_postal_code)} ${escapeHtml(payload.delivery_city)}</div>`);
    }

    $("confirmBox").innerHTML = lines.join("");
  }

  // -----------------------------
  // Step 2 -> save company details
  // -----------------------------
  $("btnStep2Next").addEventListener("click", async () => {
    showError("");
    showStatus("");

    const payload = buildStep2Payload();

    if (!requireFilled("Signup token", payload.signup_token)) return;

    if (!requireFilled("Company name", payload.company_name)) return;

    if (!requireFilled("Enterprise / VAT number", payload.vat_number)) return;
    if (!isValidBEVat(payload.vat_number)) {
      showError("VAT format required: BE 0123. 456. 789");
      return;
    }

    if (!requireFilled("Registered contact person", payload.registered_contact_person)) return;
    if (!requireFilled("Registered street + number", payload.registered_street)) return;
    if (!requireFilled("Registered postal code", payload.registered_postal_code)) return;
    if (!requireFilled("Registered city", payload.registered_city)) return;

    if (!requireFilled("Billing email", payload.billing_email)) return;
    if (!isValidEmail(payload.billing_email)) { showError("Valid billing email is required."); return; }

    if (payload.delivery_is_different) {
      if (!requireFilled("Delivery contact person", payload.delivery_contact_person)) return;
      if (!requireFilled("Delivery street + number", payload.delivery_street)) return;
      if (!requireFilled("Delivery postal code", payload.delivery_postal_code)) return;
      if (!requireFilled("Delivery city", payload.delivery_city)) return;
    }

    showStatus("Saving your company details...");

    try {
      const r = await fetch("/api/signup/step2", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(() => ({}));

      if (!r.ok || !data.ok) {
        showStatus("");
        showError(data.error || "Could not save company details.");
        return;
      }

      showStatus("");
      fillConfirmBox(payload);
      go(3);
    } catch (e) {
      showStatus("");
      showError("Network error.");
    }
  });

  $("btnStep2Back").addEventListener("click", () => go(1));

  // -----------------------------
  // Step 3 -> finalize (create company + user)
  // -----------------------------
  $("btnCreateAccount").addEventListener("click", async () => {
    showError("");
    showStatus("");

    const signup_token = $("signup_token").value.trim();
    if (!requireFilled("Signup token", signup_token)) return;

    showStatus("Creating your account...");

    try {
      const r = await fetch("/api/signup/step3", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ signup_token })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data.ok) {
        showStatus("");
        showError(data.error || "Could not create account.");
        return;
      }

      showStatus("Account created. Redirecting to login...");
      setTimeout(() => {
        window.location.href = "/login";
      }, 600);
    } catch (e) {
      showStatus("");
      showError("Network error.");
    }
  });

  $("btnStep3Back").addEventListener("click", () => go(2));

  // Start
  go(1);
</script>

</body>
</html>
